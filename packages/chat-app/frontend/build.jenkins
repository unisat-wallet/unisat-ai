

// DO NOT EDIT!
// this file is generate form jenkinsfile.tpl by generate-jenkinsfile.py.
pipeline {
    agent {
        label 'zone=aws'
    }
    options { 
        timestamps()
        disableConcurrentBuilds()
    }
    parameters {
        string(name: 'APP_VERSION', defaultValue: 'v0.1.0', description: '版本号，影响构建后的镜像 tag')
        string(name: 'GIT_BRANCH', defaultValue: 'master', description: '构建使用的分支')
        string(name: 'WS_URL', defaultValue: 'wss://chat-ai.unisat.io/ws', description: 'WebSocket URL')
        string(name: 'API_URL', defaultValue: 'https://chat-ai.unisat.io/api', description: 'Backend API URL')
    }
    environment {
        DOCKER_REGISTRY = "cr.unisat.io"
        DOCKER_CRED = "harbor-user-jenkins"
        GITHUB_TOKEN = credentials('unisat-github-token1')
        GIT_URL = "https://${GITHUB_TOKEN}@github.com/brimless-lab/unisat-ai.git"
        DOCKER_BUILD_DIR = "."
        DOCKER_REPO = "unisat/chat-app-frontend"
        DOCKER_FILE_PATH = "packages/chat-app/frontend/Dockerfile"
    }
    stages {
        stage('Prepare') {
            steps {
                script {
                    echo 'Update build name'
                    buildName("#${BUILD_NUMBER} ${APP_VERSION} ${params.GIT_BRANCH}")
                }
            }
        }
        stage('Checkout code') {
            steps {
                script {
                    echo 'Checkouting...'
                    git(
                        url: env.GIT_URL, 
                        branch: params.GIT_BRANCH
                    )
                }
            }
        }
        stage('Build') {
            steps {
                script {
                    echo "Building image: ${DOCKER_REPO}:${APP_VERSION}"
                    echo "WS_URL: ${params.WS_URL}"
                    echo "API_URL: ${params.API_URL}"
                    docker.build("${DOCKER_REPO}:${APP_VERSION}", "--build-arg NEXT_PUBLIC_WS_URL=${params.WS_URL} --build-arg NEXT_PUBLIC_API_URL=${params.API_URL} -f ${DOCKER_FILE_PATH} ${DOCKER_BUILD_DIR}")
                }
            }
            post {
                success {
                    script {
                        echo "Pushing to ${DOCKER_REGISTRY}/${DOCKER_REPO}:${APP_VERSION}"
                        docker.withRegistry("https://${DOCKER_REGISTRY}", "${DOCKER_CRED}") {
                            docker.image("${DOCKER_REPO}:${APP_VERSION}").push()
                        }
                    }
                }
            }
        }
    }
}